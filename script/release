#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

# Deploy with Kamal
#
echo "Starting deployment with Kamal..."
echo "------------------------"

echo "Building and pushing Docker image..."
bin/kamal build push
bin/kamal server exec docker pull ericroos13/read_ritual:latest

echo "Running Kamal migrations..."
bin/kamal app exec bundle exec rails db:migrate

echo "Deploying latest version to servers..."
bin/kamal deploy

# Proceed only if deploy succeeded
echo "Deployment successful. Proceeding to create release..."

# Configuration
SENTRY_ORG="eric-roos"
SENTRY_PROJECT="readritual"

# Ensure sentry-cli is available
if ! command -v sentry-cli &> /dev/null; then
  echo "Error: sentry-cli is not installed or not in PATH."
  exit 1
fi

# Propose a new release version
VERSION=$(sentry-cli releases propose-version)

echo "Creating Sentry release: $VERSION"

# Create the release
sentry-cli releases --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" new "$VERSION"

# Associate commits automatically
sentry-cli releases --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" set-commits "$VERSION" --auto --ignore-missing

# Finalize the release
sentry-cli releases --org "$SENTRY_ORG" --project "$SENTRY_PROJECT" finalize "$VERSION"

echo "Creating GitHub release: $VERSION"

# Create GitHub release using the existing tag
# Check if GitHub CLI is available
if ! command -v gh &> /dev/null; then
  echo "Warning: gh (GitHub CLI) is not installed or not in PATH. Skipping GitHub release creation."
else
  # Check if release already exists
  if gh release view "$VERSION" &> /dev/null; then
    echo "Warning: GitHub release $VERSION already exists, skipping GitHub release creation"
  else
    echo "Creating GitHub release for tag: $VERSION"
    gh release create "$VERSION" --title "Release $VERSION" --notes "Automated release $VERSION" --generate-notes
    echo "GitHub release $VERSION created successfully."
  fi
fi

echo "Git release $VERSION created, Sentry release $VERSION finalized, and GitHub release created successfully."
